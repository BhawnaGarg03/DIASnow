<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>sn_ind_tmt_orm.LIAMAPI</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>LIAMAPI</name>
        <script><![CDATA[var LIAMAPI = Class.create();
LIAMAPI.prototype = {
    getUserLIAM: function(contact, userName) {
        var createUser = '';
        var updateUser = '';
        var getUSerDetailsResponse = '';
        //gs.info("**********LIAM username*******" + userName);
        var LIAMToken = this.getLIAMToken();
        try {
            var r = new sn_ws.RESTMessageV2('LIAMToken', 'getUserDetails');
            r.setRequestHeader('Authorization', 'Bearer ' + LIAMToken);
            r.setRequestHeader('Content-Type', 'application/json');
            r.setStringParameterNoEscape('userName', userName + '');
            var response = r.execute();
            var responseBody = response.getBody();
            var httpStatus = response.getStatusCode();
            gs.info("****LIAM responseBody*****" + responseBody);
            if (httpStatus == '200' || httpStatus == '201') {
                var parseJSONResponse = JSON.parse(responseBody);
                //gs.info("*******LIAM parseResponseBody*****" + parseJSONResponse);
                var userDetails = parseJSONResponse.data.getUsers[0];
                var liamID = '';
                gs.info("****LIAM userDetails*******" + userDetails);
                if (userDetails == undefined) {
                    gs.info("**********LIAM User doens not exist***");
                    getUSerDetailsResponse = "USer does not exist in Carbon Black.";
                    //  createUser = this.createUserInLIAM(contact);
                } else {
                    var flag = false;
                    var roleAssignments = parseJSONResponse.data.getUsers[0].roleAssignments+'';
                    gs.info("***LIAM User exists*****" + roleAssignments);
                    var roleAr = roleAssignments.split(",");
                    for (var i = 0; i < roleAr.length; i++) {
                        if (roleAr[i] == 'MEDR Security Role') {
                            flag = true;
							gs.info("******LIAM roleAssigment****"+roleAr[i]);
                            break;
                        }
                    }
                    if (flag == true)
                        getUSerDetailsResponse = "User has MEDR Security Role";
                    else
                        getUSerDetailsResponse = "User does not have MEDR Security Role";

                    //  updateUser = this.updateUserInLIAM(contact, parseJSONResponse.data.getUsers[0].liamId + '');
                }
            } else
                getUSerDetailsResponse = responseBody;
        } catch (ex) {
            var message = ex.message;
        }
        return getUSerDetailsResponse;
    },
    getLIAMToken: function() {
        // var azureToken = this.getAzureToken();
        var LIAMToken = '';
        try {
            var r = new sn_ws.RESTMessageV2('LIAMToken', 'GetToken');
            // r.setRequestHeader('Authorization', 'Basic S3VhNjhra2RzWWhzQXR4dFhnT3h4UlFJR0F6VnFTQ1Q6c2Vad3JCNzY1Z1hRdzB3bQ==');
            //r.setRequestHeader('Content-Type', 'application/json');
            //r.setQueryParameter('grant_type', 'client_credentials');
            var response = r.execute();
            var responseBody = response.getBody();
            var httpStatus = response.getStatusCode();
            if (httpStatus == '200' || httpStatus == '201') {
                var parseResponse = JSON.parse(responseBody);
                LIAMToken = parseResponse.access_token;
                gs.info("****LIAM access token****" + LIAMToken);
            }
        } catch (ex) {
            var message = ex.message;
        }
        return LIAMToken;
    },
    getAzureToken: function() {
        gs.info("**********LIAM getAzureToken Called********");
        var clientid = gs.getProperty('azure.platform.client_id');
        var secret = gs.getProperty('azure.platform.servicenowusage');
        var scope = 'api://' + clientid + '/.default';
        gs.info("****LIAM Scope****" + scope);
        // GET TOKEN
        var r = new sn_ws.RESTMessageV2('LumenAzure', 'getToken');
        // r.setStringParameter('clientID', clientid);
        //r.setStringParameter('secret', secret);
        //r.setStringParameter('scope', scope);
        r.setStringParameterNoEscape('scope', 'api://36b95569-7884-4d1e-9329-eb9649d46cca/.default');
        r.setStringParameterNoEscape('clientID', '36b95569-7884-4d1e-9329-eb9649d46cca');
        r.setStringParameterNoEscape('secret', 'sSe8Q~g-XYdBp8ePcD4FOX0klT92eP1.4fDOqc43');
        var response = r.execute();
        gs.info("******LIAM Azure Response****" + response);
        var responseBody = response.getBody();
        var httpStatus = response.getStatusCode();
        gs.info("*******LIAM AZure Token REsponse**********" + httpStatus);
        var resp = JSON.parse(responseBody);
        var azureToken = resp.access_token;
        gs.info("******LIAM Azure TOKEN:" + azureToken);
        return azureToken;
    },
    createUserInLIAM: function(contact) {
        gs.info("*****LIAM createUSErCalled*******");
        var responseCreateUser = '';
        var LIAMToken = this.getLIAMToken();
        try {


            var r = new sn_ws.RESTMessageV2('LIAMToken', 'createUser');
            r.setRequestHeader('Authorization', 'Bearer ' + LIAMToken);
            r.setRequestHeader('Accept', 'application/json');
            var gr = new GlideRecord("customer_contact");
            gr.addQuery("sys_id", contact);
            gr.query();
            if (gr.next()) {
                r.setStringParameterNoEscape('company', gr.getDisplayValue('company'));
                r.setStringParameterNoEscape('displayName', gr.getDisplayValue('first_name'));
                r.setStringParameterNoEscape('userName', gr.getDisplayValue('email'));
                if (gr.getDisplayValue('mobile_phone') == '')
                    r.setStringParameterNoEscape('primaryPhone', 'NA');
                else
                    r.setStringParameterNoEscape('primaryPhone', gr.getDisplayValue('mobile_phone'));
                if (gr.getDisplayValue('title') == '')
                    r.setStringParameterNoEscape("jobTitle", "NA");
                else
                    r.setStringParameterNoEscape("jobTitle", gr.getDisplayValue('title'));
                if (gr.getDisplayValue('u_employee_type') == '')
                    r.setStringParameterNoEscape('userType', 'NA');
                else
                    r.setStringParameterNoEscape('userType', gr.getDisplayValue('u_employee_type'));
                r.setStringParameterNoEscape('countryCode', "1");
                r.setStringParameterNoEscape('lastName', gr.getDisplayValue('last_name'));
                r.setStringParameterNoEscape('firstName', gr.getDisplayValue('first_name'));
                r.setStringParameterNoEscape('email', gr.getDisplayValue('email'));
            }
            var response = r.execute();
            var responseBody = response.getBody();
            var httpStatus = response.getStatusCode();
            gs.info("*************LIAM createUser Request Body********" + r.getRequestBody());
            gs.info("********LIAM cretaeUserResponse**********" + responseBody);
            if (httpStatus == '200' || httpStatus == '201') {
                responseCreateUser = "User Created SuccessFully!!";
            } else {
                responseCreateUser = responseBody;
            }
        } catch (ex) {
            var message = ex.message;
        }
        return responseCreateUser;
    },
    updateUserInLIAM: function(contact, liamID) {
        gs.info("*****LIAM updateUserInLIAM*******");
        var responseUpdateUser = '';
        var LIAMToken = this.getLIAMToken();
        try {
            //gs.info("*****LIAM ID is ******" + liamID);

            var r = new sn_ws.RESTMessageV2('LIAMToken', 'updateUser');
            r.setRequestHeader('Authorization', 'Bearer ' + LIAMToken);
            r.setRequestHeader('Accept', 'application/json');
            var gr = new GlideRecord("customer_contact");
            gr.addQuery("sys_id", contact);
            gr.query();
            if (gr.next()) {
                r.setStringParameterNoEscape('company', gr.getDisplayValue('company'));
                r.setStringParameterNoEscape('displayName', gr.getDisplayValue('first_name'));
                r.setStringParameterNoEscape('userName', gr.getDisplayValue('email'));
                r.setStringParameterNoEscape('primaryPhone', gr.getDisplayValue('mobile_phone'));
                r.setStringParameterNoEscape('countryCode', "1");
                r.setStringParameterNoEscape('lastName', gr.getDisplayValue('last_name'));
                r.setStringParameterNoEscape('firstName', gr.getDisplayValue('first_name'));
                r.setStringParameterNoEscape('email', gr.getDisplayValue('email'));
                r.setStringParameterNoEscape('liamId', liamID);
            }
            var response = r.execute();
            var responseBody = response.getBody();
            var httpStatus = response.getStatusCode();
            gs.info("*************LIAM updateUserInLIAM Request Body********" + r.getRequestBody());
            gs.info("********LIAM updateUserInLIAM Response**********" + responseBody);
            if (httpStatus == '200' || httpStatus == '201') {
                responseUpdateUser = "User Updated SuccessFully!!";
            } else {
                responseUpdateUser = responseBody;
            }
        } catch (ex) {
            var message = ex.message;
        }
        return responseUpdateUser;
    },
    type: 'LIAMAPI'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>AD13956</sys_created_by>
        <sys_created_on>2022-09-14 16:56:22</sys_created_on>
        <sys_id>39518efb87f5dd10b25aa8ec0ebb3582</sys_id>
        <sys_mod_count>60</sys_mod_count>
        <sys_name>LIAMAPI</sys_name>
        <sys_package display_value="Order Management for Telecom, Media &amp; Tech" source="sn_ind_tmt_orm">3c58f5d55b0310102dff5e92dc81c711</sys_package>
        <sys_policy/>
        <sys_scope display_value="Order Management for Telecom, Media &amp; Tech">3c58f5d55b0310102dff5e92dc81c711</sys_scope>
        <sys_update_name>sys_script_include_39518efb87f5dd10b25aa8ec0ebb3582</sys_update_name>
        <sys_updated_by>AD13956</sys_updated_by>
        <sys_updated_on>2022-11-11 16:06:33</sys_updated_on>
    </sys_script_include>
    <sys_claim action="INSERT_OR_UPDATE">
        <claim_owner_scope display_value="Order Management for Telecom, Media &amp; Tech">3c58f5d55b0310102dff5e92dc81c711</claim_owner_scope>
        <claim_timestamp>184e6fad6d70000001</claim_timestamp>
        <metadata_update_name>sys_script_include_39518efb87f5dd10b25aa8ec0ebb3582</metadata_update_name>
        <previous_claim_app_version>2.0.2</previous_claim_app_version>
        <previous_claim_name>Order Management for Telecom, Media &amp; Tech</previous_claim_name>
        <previous_claim_scope>3c58f5d55b0310102dff5e92dc81c711</previous_claim_scope>
        <sys_created_by>AD25084</sys_created_by>
        <sys_created_on>2022-12-06 10:28:29</sys_created_on>
        <sys_id>7ac6c8a28727151094fa0e58cebb3529</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>AD25084</sys_updated_by>
        <sys_updated_on>2022-12-06 10:28:29</sys_updated_on>
    </sys_claim>
</record_update>
